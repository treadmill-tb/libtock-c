#include <stdbool.h>
#include <stdio.h>
#include <string.h>

#include <libtock-sync/services/alarm.h>
#include <libtock/interface/button.h>
#include <libtock/kernel/ipc.h>
#include <libtock/tock.h>

// Buffer size and globals
#define BUFFER_SIZE 64 // Smaller buffer size
static char shared_buffer[BUFFER_SIZE];
static size_t server_svc = 0;

// Global flags
static bool button_pressed = false;
static int pressed_button = 0;
static volatile int restart_count = 0;

// Simple callback from server
static void server_callback(int pid, int len, int arg2, void *ud) {
  printf("Client: Received callback from server (pid=%d)\n", pid);
}

// Button callback
static void button_callback(returncode_t ret, int num, bool val) {
  if (val) {
    pressed_button = num;
    button_pressed = true;
  }
}

// Fill buffer with pattern
static void initialize_buffer(void) {
  printf("Client: Initializing buffer at %p with size %d\n", shared_buffer,
         BUFFER_SIZE);
  memset(shared_buffer, 0, BUFFER_SIZE);

  // Use a very simple pattern
  for (int i = 1; i < BUFFER_SIZE - 1; i++) {
    shared_buffer[i] = (char)('A' + (i % 26));
  }

  // First byte is reserved for command
  shared_buffer[0] = 0;
  printf("Client: Buffer initialized\n");
}

// Trigger a crash
static void trigger_crash(void) {
  printf("Client: Triggering crash...\n");
  volatile int x = 1;
  volatile int y = 0;
  volatile int z = x / y;
  printf("Should never print: %d\n", z);
}

int main(void) {
  printf("Vulnerability Demo Client starting (restart_count=%d)\n",
         restart_count);
  restart_count++;

  // Wait a moment to ensure server is ready
  printf("Client: Waiting for a moment...\n");
  libtocksync_alarm_delay_ms(1000);

  // Initialize buffer
  initialize_buffer();

  // Setup buttons
  libtock_button_notify_on_press(0, button_callback);
  libtock_button_notify_on_press(1, button_callback);

  // Discover server service
  printf("Client: Looking for server service...\n");
  int retry = 0;
  int err = -1;
  while (err < 0 && retry < 10) {
    err = ipc_discover("server", &server_svc);
    if (err < 0) {
      printf("Client: Retry %d - server not found\n", retry);
      libtocksync_alarm_delay_ms(1000);
      retry++;
    }
  }

  if (err < 0) {
    printf("Client: Failed to find server service\n");
    return -1;
  }

  printf("Client: Found server at service %d\n", server_svc);

  // Register for callbacks
  printf("Client: Registering for server callbacks\n");
  ipc_register_client_callback(server_svc, server_callback, NULL);

  // Simple main loop
  printf("Client: Entering main loop\n");
  printf("Client: Press Button 1 to crash\n");

  while (1) {
    yield();

    if (button_pressed) {
      if (pressed_button == 1) {
        trigger_crash();
      }
      button_pressed = false;
    }
  }

  return 0;
}
